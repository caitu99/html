<!DOCTYPE html>
<html>
	<head>

		<meta charset="utf-8">
		<meta name="keywords" content="积分生活, ifen, caitu99, caitu" />
		<meta name="description" content="财途积分生活，尽享每一分" />
		<meta content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport">
		<!-- Mobile Devices Support @begin -->
		<meta content="no-cache" http-equiv="Cache-Control">
		<meta content="no-cache" http-equiv="pragma">
		<meta content="0" http-equiv="expires">
		<meta content="telephone=no, address=no" name="format-detection">
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<!-- apple devices fullscreen -->
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
		<title>财途积分生活-企业信息查询</title>
				
		<link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap.min.css">
		<link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.3.0/css/bootstrap-theme.min.css">	
		<link rel="stylesheet" href="css/style.css">	
		<link href="css/bootstrap-datetimepicker.css" rel="stylesheet" type="text/css" />
		
		
		<script src="http://cdn.bootcss.com/jquery/1.11.3/jquery.min.js"></script>
		<script src="http://cdn.bootcss.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
        <script src="../js/jquery.cookie.js"></script>
		<script src="js/bootstrap-datetimepicker.js" type="text/javascript"></script>
		<script src="js/locales/bootstrap-datetimepicker.zh-CN.js" type="text/javascript"></script>


		<style>
			.table{
				
				width:2000px;
			   
			    max-width:2000px;
			}
			.table>tbody>tr>td{
				padding: 0 8px;
			    line-height: 1.42857143;
			    vertical-align: middle;
			    border-top: 1px solid #ddd;
			}
			.table>thead>tr>th{
			   vertical-align: middle;
			   text-align:center;
		}
		.box_size{
		overflow-x: auto;
		width:100%;
		  max-width:100%;
		}
			
			
			
		</style>	
	</head>

	<body>
		<div class="container">


			<!-- head -->
			<div class="row clearfix" style="margin-top:20px;">
				<div class="col-md-12 column">
					<div class="alert alert-success alert-dismissable alert-info">
						<h4>
							财途积分生活
							
						</h4> 
						<p>企业信息查询<span id="welcome">欢迎，unionpay999</span></p>
					</div>
				</div>
			</div>

			<div class="row clearfix">

				<!-- left -->
				<div class="col-md-2 column">
					<div class="panel-group" id="panel-883738">
						<div class="panel panel-default">
							<div class="panel-heading">&nbsp;</div>
							<div id="panel-element-890624" class="panel-collapse collapse in">
								<div class="panel-body"><a id="account_info" href="query_info.html">账户信息</a></div>
								<div class="panel-body"><a id="account_detail" href="#">账户明细</a></div>
                               <!--  <div class="panel-body"><a id="tran_info" href="#">交易明细</a></div>
								<div class="panel-body"><a id="order_query" href="#">充值交易查询</a></div> -->
							</div>
						</div>
					</div>
				</div>

				
				<div class="col-md-10 column">
					<!-- right -->
					<div id="timebox" style="">
					
						
							<a href="#" id="button_query" class="btn btn-primary" >查询</a>
						
					
						<div class="time-item col-md-8">
							<span style="float:left;">结束时间:</span>
							<div id="input_end_time_" class="input-group date form_datetime col-md-8" data-date-format="yyyy-MM-dd hh:ii:ss">		
								<input class="form-control" type="text" id="input_end_time" placeholder="选择后查询"/>
								<span class="input-group-addon"> <span class="glyphicon glyphicon-th"></span></span>
							</div>
						</div>
						
						<div class="time-item col-md-8">
							<span style="float:left;">开始时间:</span>
							<div id="input_start_time_" class="input-group date form_datetime col-md-8" data-date-format="yyyy-MM-dd hh:ii:ss">
								<input class="form-control" type="text" id="input_start_time" placeholder="选择后查询"/>
								<span class="input-group-addon"><span class="glyphicon glyphicon-th"></span></span>
							</div>
						</div>
						
					</div>
					
					
					<div id="options" style="display:none;">
						
						<a href="#" id="button_query_numbers" class="btn btn-primary" >查询</a>
						
						<div class="col-md-3">
							<span>流水号: </span><input type="text" id="input_thirdNo" class="form-control" placeholder="填写后即可查询"/>
						</div>
						
						<div class="col-md-3">
							<span>订单号: </span><input type="text" id="input_orderNo" class="form-control" placeholder="填写后即可查询"/>
						</div>
						
						<div class="col-md-3">
							<span>手机号: </span><input type="text" id="input_mobile" class="form-control" placeholder="填写后即可查询" maxlength="11" />
						</div>
						
					</div>
					
				
			<div class="box_size">
						<table class="table table-bordered">
						<thead id="t_head"  >
							<tr >
								<th>订单号</th>
								<th>交易流水号</th>
								<th>提交日期</th>
						   	<!-- 	<th>清算日期</th> -->
						   		<th>银行账号</th>
						   		<th>银行户名</th>
						   		<th>业务商户</th>
						   		<th>业务名称</th>
						  		<th>交易金额（元）</th>
						  		<th>手续费</th>
						  		<th>处理状态</th>
						  		<th>交易结果</th>
							</tr>
						</thead>
						<tbody id="t_body">
							<tr>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
							</tr>
						</tbody>
					</table>
			</div>
					<div id="choosepages" class="col-md-8 column"  style=""> 
						<table> 
							<tr >
								<td style="display:inline-block">
								当前第<span id="curPage_p">1</span>页
								</td>
								<td  style="display:inline-block">
									<a  href="#" id="prePage" >上一页</a>
									<a  href="#" id="nextPage">下一页</a>
								</td>
								<td style="display:inline-block" >
									转到&nbsp;<input id="changePage" type="text" size="3" />&nbsp;页
									<a href="#" id="skipPage">跳转</a>
									共<span id="totalPage_p">1</span>页
								</td>
							</tr>
						</table>
					</div>
				</div>
			</div>
		</div>


		<!-- login modal -->
		<div id="login_modal" class="modal fade" role="dialog" data-backdrop="static" data-keyboard="false">
			<div class="modal-dialog" style="width:400px;">
				<div class="modal-content">
					<div class="modal-header">
						<h3 class="modal-title">登录</h3>
					</div>
					<div class="modal-body">
						<div class="form-group">
							<label for="account">Account</label>
							<input type="email" class="form-control" id="account"/>
						</div>
						<div class="form-group">
							<label for="password">Password</label>
							<input type="password" class="form-control" id="password"/>
						</div>
					</div>
					<div class="modal-footer">
						<label id="message" style="margin-right: 20px; color: red;"></label>
						<button id="submitlogin" type="button" class="btn btn-default">确认</button>
					</div>
				</div>

			</div>
		</div>
		

	</body>
</html>

<script type="text/javascript">

    //for test
    //$.cookie("caitu99_cookie", null, {expires: -1});

    var host = "http://p.gateway.caitu99.com";
	//var host = "http://localhost";
    var loginurl = host + "/oauth/enterprise/login";
    var tokenurl = host + "/oauth/token";
    var apiurl = host + "/gw/oauthentry";
    
    var userid = 111;	
    
	var curpage = 1;
	var pagesize = 10;
	var totalpage = 1;
	var active_url = apiurl + "/enterprise.account/1.0/info";
	
    $(document).ready(function(){	
		$(".form_datetime").datetimepicker({
		format: 'yyyy-mm-dd',
		todayBtn: true,
		autoclose: true,
		minView:"month"
		
		});
        // check login
        var token = $.cookie("caitu99_cookie");
        if (token == null) {
            $("#login_modal").modal("show");
        }
        $("#submitlogin").bind("click", function () {
            $("#message").text("");
            var account = $("#account").val();
            var password = $("#password").val();

            account = $.trim(account);
            password = $.trim(password);

            if (account == "" || password == "") {
                $("#message").text("请输入账号密码");
                return;
            }
            $.post(loginurl, {account: account, password: password}, function (result) {
                if (result.code != 0) {
                    $("#message").text(result.message);
                    return;
                }

                $.post(tokenurl, {grant_type: "password", client_id: result.data.clientId,  client_secret: result.data.clientSecret, username: account, password: password, type: 4}, function (result) {
                    if(result.access_token) {
                        $.cookie('caitu99_cookie', result.access_token, {expires: 7});
                    } else {
                        $("#message").text(result.error_description);
                        return;
                    }
                    $("#login_modal").modal("hide");
                   // $("#account_info").click();
                });
            });

        });
		
		//账户明细
		$("#account_detail").bind("click", function() {
			// check login
			var token = $.cookie("caitu99_cookie");
            if (token == null) {
                $("#login_modal").modal("show");
            }
			
			//change params 
			$("#t_body").html(t_body);
			
			var start_time = input_start_time.value;
			var end_time = input_end_time.value;
			if( start_time!='' && end_time!=''){
				post_account_detail(curpage,pagesize);
			}


		})
		
		
		
		//上一页
		$("#prePage").bind("click", function() {
			// check login
			var token = $.cookie("caitu99_cookie");
            if (token == null) {
                $("#login_modal").modal("show");
            }
			
			//check params
			if(curpage > 1){
				curpage =  Number(curpage) - 1;
			}else{
				curpage = 1;
			}
			
			var start_time = input_start_time.value;
			var end_time = input_end_time.value;
			if( start_time == ""){
				alert("请选择开始时间");
				return;
			}else if( end_time == "" ){
				alert("请选择结束时间");
				return;
			}
			
			start_time = start_time + ' 00:00:00';
			end_time = end_time + ' 23:59:59';
			
		    post_account_detail(curpage,pagesize);
		});
		
		//下一页
		$("#nextPage").bind("click", function() {
			if( curpage == totalpage ){
				return;
			}
			// check login
			var token = $.cookie("caitu99_cookie");
            if (token == null) {
                $("#login_modal").modal("show");
            }
			//check params
			if(curpage >= 1){
				curpage =  Number(curpage) + 1;
			}else{
				curpage = 1;
			}
				var start_time = input_start_time.value;
				var end_time = input_end_time.value;
				if( start_time == ""){
					alert("请选择开始时间");
					return;
				}else if( end_time == "" ){
					alert("请选择结束时间");
					return;
				}
				
				start_time = start_time + ' 00:00:00';
				end_time = end_time + ' 23:59:59';
				
				
				post_account_detail(curpage,pagesize);
			
		});
		
		//跳转到指定页数
		$("#skipPage").bind("click", function() {
		
			// check login
			var token = $.cookie("caitu99_cookie");
            if (token == null) {
                $("#login_modal").modal("show");
            }

			curpage = eval(document.getElementById('changePage')).value;
				//check params
				if( isNaN(curpage) || curpage == '' || curpage == undefined){
				alert('请输入正确的页数');
				return;
				}
				var start_time = input_start_time.value;
				var end_time = input_end_time.value;
				if( start_time == ""){
					alert("请选择开始时间");
					return;
				}else if( end_time == "" ){
					alert("请选择结束时间");
					return;
				}
				
				start_time = start_time + ' 00:00:00';
				end_time = end_time + ' 23:59:59';
				
				post_account_detail(curpage,pagesize);
	
		});
		
		//查询
		$("#button_query").bind("click", function() {
			button_query_fun(curpage,pagesize);
		});
		$("#button_query_numbers").bind("click", function() {
			button_query_fun(curpage,pagesize);
		});
		

    });
	
	
	
	function button_query_fun(curpage,pagesize)
	{
			post_account_detail(curpage,pagesize);
	}
	
	//账户明细查询方法
	function post_account_detail(curpage,pagesize)
	{
		var token = $.cookie("caitu99_cookie");
        if (token == null) {
            $("#login_modal").modal("show");
        }
		
		// check params
		var start_time = input_start_time.value;
		var end_time = input_end_time.value;
		if( start_time == ""){
			alert("请选择开始时间");
			return;
		}else if( end_time == "" ){
			alert("请选择结束时间");
			return;
		}
		
		start_time = start_time + ' 00:00:00';
		end_time = end_time + ' 23:59:59';
		
		
		//var accountDetailUrl = "/api/transaction/enterprise/account/detail/1.0";
		var accountDetailUrl = apiurl + "/enterprise.account/1.0/detail";
		
		console.log(curpage,pagesize);
		
		
/* 		$.post(accountDetailUrl, {access_token: token, startDate:start_time, endDate:end_time, curPage:curpage, pageSize:pagesize}, function (result) {
			if(result.code == 0){
				
				$("#t_body").html( ergodic_account_detail_data(result.data) );		
			}else{
				tofail(result);
			}
        }); */
		
		
 		$.post(accountDetailUrl, {access_token: token, start:start_time, end:end_time, curpage:curpage, pagesize:pagesize}, function (result) {
			if(result.code == 0){
				
				$("#t_body").html( ergodic_account_detail_data(result.data) );		
			}else{
				tofail(result);
			}
        }); 

	}
	
	function tofail(result){
		//5110
		if(result.code=='5110'){
			alert("登录超时，点击确定重新登录！");
			$("#login_modal").modal("show");
			//$.cookie.removeCookie()
		}else{
			alert(result.message);
		}
	}
	
	
	//账户明细解析方法
	function ergodic_account_detail_data(data)
	{
		var result = "";
		var datas = data.datas;
		
		for(var o in datas){
			result = result + "<tr>"
				   + "<td>" +  datas[o].orderNo + "</td>"
				   + "<td>" +  datas[o].transactionNumber + "</td>"
				   + "<td>" +  datas[o].createTimeString + "</td>"
				  /*  + "<td>" +  datas[o].createTimeString + "</td>" */
				   + "<td>" +  datas[o].accNo + "</td>"
				   + "<td>" +  datas[o].accName + "</td>"
				   + "<td>" +  datas[o].channelString + "</td>"
				   + "<td>" +  datas[o].typeString + "</td>"
				   + "<td>" +  datas[o].totalString + "</td>"
				   + "<td>" +  datas[o].feeString + "</td>"
				   + "<td>" +  datas[o].handleStatusString + "</td>"
				   + "<td>" +  datas[o].statusString + "</td>"
				   + "</tr>";			
		} 
		curpage = data.curPage;
		totalpage = data.totalPage;
		document.getElementById("curPage_p").innerHTML = curpage;
		document.getElementById("totalPage_p").innerHTML = totalpage;
		return result;
	}
	
	

</script>
