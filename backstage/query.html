<!DOCTYPE html>
<html>
	<head>

		<meta charset="utf-8">
		<meta name="keywords" content="积分生活, ifen, caitu99, caitu" />
		<meta name="description" content="财途积分生活，尽享每一分" />
		<meta content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport">
		<!-- Mobile Devices Support @begin -->
		<meta content="no-cache" http-equiv="Cache-Control">
		<meta content="no-cache" http-equiv="pragma">
		<meta content="0" http-equiv="expires">
		<meta content="telephone=no, address=no" name="format-detection">
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<!-- apple devices fullscreen -->
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
		<title>财途积分生活-运营后台信息查询</title>
				
		<link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap.min.css">
		<link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.3.0/css/bootstrap-theme.min.css">	
		<link rel="stylesheet" href="css/style.css">	
		<link href="css/bootstrap-datetimepicker.css" rel="stylesheet" type="text/css" />
		
		
		<script src="http://cdn.bootcss.com/jquery/1.11.3/jquery.min.js"></script>
		<script src="http://cdn.bootcss.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
        <script src="../js/jquery.cookie.js"></script>
		<script src="js/bootstrap-datetimepicker.js" type="text/javascript"></script>
		<script src="js/locales/bootstrap-datetimepicker.zh-CN.js" type="text/javascript"></script>

	</head>

	<body>
		<div class="container">

			<!-- head -->
			<div class="row clearfix" style="margin-top:20px;">
				<div class="col-md-12 column">
					<div class="alert alert-success alert-dismissable alert-info">
						<h4>
							财途积分生活
						</h4> 
						<p>运营后台信息查询<span id="welcome"></span></p>
					</div>
				</div>
			</div>

			<div class="row clearfix">

				<!-- left -->
				<div class="col-md-2 column">
					<div class="panel-group" id="panel-883738">
						<div class="panel panel-default">
							<div class="panel-heading">&nbsp;</div>
							<div id="panel-element-890624" class="panel-collapse collapse in">
								<div class="panel-body"><a id="integraldata_info" href="#">财币信息</a></div>
								<div class="panel-body"><a id="virtualGoodsInventory_info" href="#">虚拟商品库存</a></div>
								<div class="panel-body"><a id="user_info" href="#">用户信息</a></div>
								<div class="panel-body"><a id="summy" href="#">统计信息</a></div>
								<div class="panel-body"><a id="user_statistics" href="#">用户信息统计</a></div>
							</div>
						</div>
					</div>
				</div>

				
				<div class="col-md-10 column">
					<!-- right -->
					<div id="timebox">
						<a href="#" id="button_query" class="btn btn-primary" >查询</a>

						<div class="time-item col-md-8">
							<span style="float:left;">结束时间:</span>
							<div id="input_end_time_" class="input-group date form_datetime col-md-8" data-date-format="yyyy-MM-dd hh:ii:ss">		
								<input class="form-control" type="text" id="input_end_time" placeholder="选择后查询"/>
								<span class="input-group-addon"> <span class="glyphicon glyphicon-th"></span></span>
							</div>
						</div>
						
						<div class="time-item col-md-8" style="display:none;">
							<span style="float:left;">开始时间:</span>
							<div id="input_start_time_" class="input-group date form_datetime col-md-8" data-date-format="yyyy-MM-dd hh:ii:ss">
								<input class="form-control" type="text" id="input_start_time" placeholder="选择后查询"/>
								<span class="input-group-addon"><span class="glyphicon glyphicon-th"></span></span>
							</div>
						</div>
						
					</div>

					<div id="options" style="display:none;">

						<a href="#" id="button_query_numbers" class="btn btn-primary" >查询</a>

						<div class="col-md-3">
							<span>结束用户ID: </span><input type="text" id="input_endUserId" class="form-control" placeholder="填写后查询" value="9999"/>
						</div>

						<div class="col-md-3">
							<span>起始用户ID: </span><input type="text" id="input_startUserId" class="form-control" placeholder="填写后查询" value="1"/>
						</div>

					</div>

					<table class="table table-bordered">
						<thead id="t_head">
							<tr>
								<th>
									财途积分生活
								</th>
								<th>
									用户入分
								</th>
								<th>
									用户出分
								</th>
								<th>
									送分
								</th>
								<th>
									测试入分
								</th>

								<th>
									测试出分
								</th>
								<th>
									入分汇总
								</th>
								<th>
									出分汇总
								</th>
								<th>
									财币变动
								</th>
								<th>
									平台总财币
								</th>
							</tr>
						</thead>
						<tbody id="t_body">
							<tr>
								<td>
								</td>
								<td>
								</td>
								<td>
								</td>
								<td>
								</td>
								<td>
								</td>
								<td>
								</td>
								<td>
								</td>
								<td>
								</td>
								<td>
								</td>
								<td>
								</td>
							</tr>
						</tbody >
					</table>
				</div>
			</div>
		</div>


		<!-- login modal -->
		<div id="login_modal" class="modal fade" role="dialog" data-backdrop="static" data-keyboard="false">
			<div class="modal-dialog" style="width:400px;">
				<div class="modal-content">
					<div class="modal-header">
						<h3 class="modal-title">登录</h3>
					</div>
					<div class="modal-body">
						<div class="form-group">
							<label for="account">Account</label>
							<input type="email" class="form-control" id="account"/>
						</div>
						<div class="form-group">
							<label for="password">Password</label>
							<input type="password" class="form-control" id="password"/>
						</div>
					</div>
					<div class="modal-footer">
						<label id="message" style="margin-right: 20px; color: red;"></label>
						<button id="submitlogin" type="button" class="btn btn-default">确认</button>
					</div>
				</div>

			</div>
		</div>
		

	</body>
</html>

<script type="text/javascript">


    var host = "http://gateway.caitu99.com";
	//var host = "http://localhost";
    var loginurl = host + "/oauth/enterprise/login";
    var tokenurl = host + "/oauth/token";
    var apiurl = host + "/gw/oauthentry";
    
    var integerdata = apiurl + "/backstage.integraldata/1.0/list";
    //var integerdata = "/api/backstage/integraldata/list/1.0";
    

	var pagesize = 2;
	var active = 1; //1 账户信息 2账户明细 3交易明细 4充值交易查询
	var totalpage = 1;
	var active_url = apiurl + "/backstage.integraldata/1.0/list";
	
    $(document).ready(function(){	
		$(".form_datetime").datetimepicker({
		format: 'yyyy-mm-dd',
		todayBtn: true,
		autoclose: true,
		minView:"month"
		
		});
		var cur_time = new Date().toLocaleDateString();
		input_end_time.value = cur_time.replace('\/','-').replace('\/','-');
        // check login
        var token = $.cookie("caitu99_cookie");
        if (token == null) {
            $("#login_modal").modal("show");
        }else{
        	post_integraldata_list();
        }
        
        $("#submitlogin").bind("click", function () {
            $("#message").text("");
            var account = $("#account").val();
            var password = $("#password").val();

            account = $.trim(account);
            password = $.trim(password);

            if (account == "" || password == "") {
                $("#message").text("请输入账号密码");
                return;
            }
            $.post(loginurl, {account: account, password: password}, function (result) {
                if (result.code != 0) {
                    $("#message").text(result.message);
                    return;
                }

                $.post(tokenurl, {grant_type: "password", client_id: result.data.clientId,  client_secret: result.data.clientSecret, username: account, password: password, type: 4}, function (result) {
                    if(result.access_token) {
                        $.cookie('caitu99_cookie', result.access_token, {expires: 7});
                        post_integraldata_list();
                    } else {
                        $("#message").text(result.error_description);
                        return;
                    }
                    $("#login_modal").modal("hide");
                    $("#integraldata_info").click();
                });
            });

        });
		
		//平台财币信息
        $("#integraldata_info").bind("click",post_integraldata_list)
		
		//虚拟商品库存
		$("#virtualGoodsInventory_info").bind("click", function() {
			//change params 
			if( 2 != active ){
				active_url = apiurl + "/backstage.virtualGoodsInventory/1.0/list";
				active = 2;
			}
			post_vgi_info();
		})

		//用户信息
		$("#user_info").bind("click",function(){
			window.open("query_userinfo.html");
		});
		
        
		$("#user_statistics").bind("click",function(){
			window.open("user_statistics.html");
		});
		
		
      //用户信息
		$("#summy").bind("click",function(){
			window.open("summy.html");
		})
		
		//查询
		$("#button_query").bind("click", function() {
			$("#button_query").css("disabled","disabled").css("background","#eee").css("border","none");
			
			button_query_fun();
		});
		$("#button_query_numbers").bind("click", function() {
			button_query_fun();
		});
		

    });

	//平台财币信息
	function post_integraldata_list(){
		// check login
		var token = $.cookie("caitu99_cookie");
		if (token == null) {
			$("#login_modal").modal("show");
		}
		//change params 
		if( 1 != active ){
			integraldata_url = apiurl + "/backstage.integraldata/1.0/list";
			active = 1;   //1财币信息查询 2虚拟商品库存查询
		}
		var query_time = input_end_time.value;
		if( query_time == ""){
			alert("请选择查询时间");
			return;
		}
		query_time = query_time + ' 00:00:00';

		$.post(integerdata, {access_token: token, date:query_time}, function (result) {
			$("#button_query").css("background","#2d6ca2");
			if(result.code == 0){
				$("#t_head").html("<tr><th>财途积分生活</th><th>用户入分</th><th>用户出分</th><th>送分</th><th>测试入分</th><th>测试出分</th><th>入分汇总</th><th>出分汇总</th><th>财币变动</th><th>平台总财币</th></tr>");
				$("#t_body").html( ergodic_integraldata_list_data(result.data) );
			}else{
				tofail(result);
			}
		});
	}
	

	//虚拟商品库存
	function post_vgi_info()
	{
		var token = $.cookie("caitu99_cookie");
        if (token == null) {
            $("#login_modal").modal("show");
        }
		
		// check params
		var query_time = input_end_time.value;
		if( query_time == "" ){
			alert("请选择查询时间");
			return;
		}
		query_time = query_time + ' 23:59:59';

		$.post(apiurl + "/backstage.virtualGoodsInventory/1.0/list", {access_token: token, date:query_time}, function (result) {
			$("#button_query").css("background","#2d6ca2");
			if(result.code == 0){
				$("#t_head").html("<tr><th>商品ID</th><th>商品名称</th><th>初始库存</th><th>冻结库存</th><th>实际库存</th><th>兑换数量</th><th>过期</th></tr>");
				$("#t_body").html(ergodic_virtualGoodsInventory_list_data(result.data));
			}else{
				tofail(result);
			}
        });

	}

	function button_query_fun()
	{
		if( active == 1 ){
			post_integraldata_list();
		}else if( active == 2){
			post_vgi_info();
		}else if( active == 3){
			//post_user_info(curpage);
		}
	}


	function tofail(result){
		//5110
		if(result.code=='5110'){
			alert("登录超时，点击确定重新登录！");
			$("#login_modal").modal("show");
			//$.cookie.removeCookie()
		}else{
			alert(result.message);
		}
	}


	//平台财币数据解析
	function ergodic_integraldata_list_data(datas)
	{
		var result = "";
		for(var o in datas){
			result = result + "<tr>";
			result = result + "<td>" +  o + "</td>";
			result = result + "<td>" +  datas[o].userIncreaseIntegral + "</td>";
			result = result + "<td>" +  datas[o].userReduceIntegral + "</td>";
			result = result + "<td>" +  datas[o].giftIntegral + "</td>";
			result = result + "<td>" +  datas[o].testIncreaseIntegral + "</td>";
			result = result + "<td>" +  datas[o].testReduceIntegarl + "</td>";
			result = result + "<td>" +  datas[o].increaseIntegralTotal + "</td>";
			result = result + "<td>" +  datas[o].reduceIntegralTotal + "</td>";
			result = result + "<td>" +  datas[o].totalChange + "</td>";
			result = result + "<td>" +  datas[o].totalIntegral + "</td>";
			result = result + "</tr>";
		}
		return result;
	}
	
	//虚拟库存解析方法
	function ergodic_virtualGoodsInventory_list_data(datas)
	{
		var result = "";
		for(var o in datas){   
			result = result + "<tr>";
			result = result + "<td>" +  datas[o].goodsID + "</td>";
			result = result + "<td>" +  datas[o].goodsName + "</td>";
			result = result + "<td>" +  datas[o].initialInventory + "</td>";
			result = result + "<td>" +  datas[o].frozenInventory + "</td>";
			result = result + "<td>" +  datas[o].actualInventory + "</td>";
			result = result + "<td>" +  datas[o].exchangeQuantity + "</td>";
			result = result + "<td>" +  datas[o].overdue + "</td>";
			result = result + "</tr>";
		}
		return result;
	}

	$('.panel-body a').click(function(){

		if( ($(this).attr('id') == 'integraldata_info') || ($(this).attr('id') == 'virtualGoodsInventory_info') )  {
			$('#timebox').show();
		}else {
			$('#timebox').hide();
		}

	});


</script>

